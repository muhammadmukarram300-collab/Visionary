<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visionary</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font and Montserrat for Logo/Headings -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Montserrat:wght@600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Base styles for the body and app container */
        body {
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #fff;
            overflow-x: hidden; /* Prevent horizontal overflow on the body */
            overflow-y: auto; 
            transition: background 0.7s ease-in-out; /* Smooth background transition */
        }

        /* Specific background gradients for different pages */
        body.bg-welcome {
            background-image: url('https://i.ibb.co/FLf77N7q/image.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }
        body.bg-home {
            background: linear-gradient(135deg, #1a2a6c 0%, #b21f1f 50%, #fdbb2d 100%);
        }
        body.bg-mindset {
            background: linear-gradient(135deg, #00416A 0%, #E4E5E6 100%);
        }
        body.bg-ai {
            background: linear-gradient(135deg, #1D2B64 0%, #F8CDDA 100%);
        }
        body.bg-analysis {
            background: linear-gradient(135deg, #4CAF50 0%, #8BC34A 100%);
        }
        body.bg-settings {
            background: linear-gradient(135deg, #607D8B 0%, #9E9E9E 100%);
        }
        body.bg-history {
            background: linear-gradient(135deg, #8E2DE2 0%, #4A00E0 100%);
        }

        .app-container {
            background-color: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(12px);
            border-radius: 20px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4);
            width: 95%;
            max-width: 450px;
            height: 90vh;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden; /* Hide overflow for the container itself */
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Styles for the horizontally scrollable pages wrapper */
        #pages-wrapper {
            display: flex;
            flex-grow: 1; /* Allow it to take available space */
            overflow-x: scroll; /* Enable horizontal scrolling */
            scroll-snap-type: x mandatory; /* Snap to pages */
            scroll-behavior: smooth; /* Smooth scrolling */
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
            height: 100%; /* Take full height of app-container content area */
        }

        .page {
            flex-shrink: 0; /* Prevent pages from shrinking */
            width: 100%; /* Each page takes full width of the wrapper */
            padding: 20px;
            overflow-y: auto; /* Allow vertical scrolling within each page */
            padding-bottom: 80px; /* Add padding at the bottom to prevent nav bar overlap */
            box-sizing: border-box; /* Include padding in width calculation */
            scroll-snap-align: start; /* Snap to the start of each page */
            display: flex; /* Ensure flex for content alignment within page */
            flex-direction: column;
        }
        /* Hide opening and intermediate pages by default as they are not part of the main scrollable content */
        #opening-page, #intermediate-slide {
            display: none; 
        }

        .nav-bar {
            display: flex;
            justify-content: space-around;
            padding: 15px 0;
            background-color: rgba(0, 0, 0, 0.3);
            border-top: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.2);
            transition: opacity 0.3s ease-in-out;
            position: relative;
            flex-shrink: 0;
        }
        .nav-button {
            background: none;
            border: none;
            color: #fff;
            font-size: 0.95rem;
            font-weight: 600;
            padding: 10px 12px;
            border-radius: 15px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
        }
        .nav-button:hover {
            background-color: rgba(255, 255, 255, 0.25);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        .nav-button.active {
            background-color: #a78bfa;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            transform: translateY(-2px);
        }
        .vision-card {
            background-color: rgba(255, 255, 255, 0.15);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s ease;
        }
        .vision-card:hover {
            transform: translateY(-3px);
        }
        .vision-card input[type="text"],
        .vision-card textarea,
        .analysis-textarea,
        .ai-analysis-textarea,
        .settings-input {
            background-color: rgba(255, 255, 255, 0.25);
            border: 1px solid rgba(255, 255, 255, 0.4);
            border-radius: 10px;
            padding: 8px 12px;
            color: #fff;
            width: 100%;
            margin-top: 8px;
            box-sizing: border-box;
        }
        .vision-card input::placeholder,
        .vision-card textarea::placeholder,
        .analysis-textarea::placeholder,
        .ai-analysis-textarea::placeholder,
        .settings-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        .vision-card input:focus,
        .vision-card textarea:focus,
        .analysis-textarea:focus,
        .ai-analysis-textarea:focus,
        .settings-input:focus {
            outline: none;
            border-color: #c4b5fd;
            box-shadow: 0 0 0 3px rgba(196, 181, 253, 0.6);
        }
        .action-button {
            background-color: #a78bfa;
            color: white;
            padding: 10px 15px;
            border-radius: 15px;
            font-weight: 600;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        .action-button:hover {
            background-color: #8b5cf6;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
        }
        .delete-button {
            background-color: #ef4444;
            color: white;
            padding: 8px 12px;
            border-radius: 10px;
            font-weight: 600;
            transition: background-color 0.3s ease;
        }
        .delete-button:hover {
            background-color: #dc2626;
        }
        .modal {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal.show {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: #3a0b5b;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.6);
            text-align: center;
            width: 90%;
            max-width: 350px;
            transform: translateY(-20px);
            transition: transform 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .modal.show .modal-content {
            transform: translateY(0);
        }
        .logo-img { 
            width: 100%;
            max-width: 150px;
            height: auto;
            margin-bottom: 20px;
            border-radius: 50%; /* Re-added for circular shape */
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3); /* Re-added for shadow */
        }
        
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #a78bfa;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Stylish Headings */
        .stylish-heading-welcome {
            font-family: 'Montserrat', sans-serif;
            font-size: 3.5rem;
            font-weight: 800;
            text-shadow: 0px 5px 10px rgba(0, 0, 0, 0.5);
            letter-spacing: 2px;
            line-height: 1.2;
            background: linear-gradient(45deg, #FFD700, #FF8C00);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: inline-block;
        }

        .stylish-heading-atomic {
            font-family: 'Montserrat', sans-serif;
            font-size: 2.5rem;
            font-weight: 700;
            text-shadow: 0px 3px 7px rgba(0, 0, 0, 0.4);
            letter-spacing: 1px;
            color: #c4b5fd;
        }

        /* General Stylish Text */
        .stylish-text {
            font-family: 'Inter', sans-serif;
            font-weight: 400;
            color: rgba(255, 255, 255, 0.9);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }
        .stylish-text-italic {
            font-family: 'Inter', sans-serif;
            font-style: italic;
            font-weight: 300;
            color: rgba(255, 255, 255, 0.8);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        .stylish-subheading {
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            color: #a78bfa;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        /* Intermediate Slide - now hidden by default */
        #intermediate-slide .text-line {
            background: linear-gradient(45deg, #FFD700, #FF8C00);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-family: 'Montserrat', sans-serif;
            font-weight: 800;
            text-shadow: 0px 5px 10px rgba(0, 0, 0, 0.5);
            font-size: 2.8rem;
            animation: pulse 1.5s infinite alternate;
            text-align: center;
            padding: 0 20px;
        }
        @keyframes pulse {
            from { transform: scale(1); opacity: 0.9; }
            to { transform: scale(1.05); opacity: 1; }
        }

        /* Progress Bar for Analysis Page */
        .progress-bar-container {
            width: 100%;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
        }
        .progress-bar {
            height: 20px;
            background-color: #4CAF50;
            width: 0%;
            border-radius: 10px;
            transition: width 0.5s ease-in-out;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: bold;
            color: white;
        }
        .progress-bar.red {
            background-color: #ef4444;
        }
        .analysis-card {
            background-color: rgba(255, 255, 255, 0.15);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            text-align: center;
        }
        .analysis-card h3 {
            font-size: 1.8rem;
            font-weight: 700;
            color: #c4b5fd;
            margin-bottom: 5px;
        }
        .analysis-card p {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.8);
        }
        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .vision-toggle-btn {
            background-color: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            padding: 6px 10px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            margin-top: 10px;
        }
        .vision-toggle-btn.completed {
            background-color: #4CAF50;
            border-color: #4CAF50;
        }
        .vision-toggle-btn:hover {
            transform: translateY(-1px);
            background-color: rgba(255, 255, 255, 0.3);
        }
        .settings-option {
            background-color: rgba(255, 255, 255, 0.15);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #4CAF50;
        }

        input:focus + .slider {
            box-shadow: 0 0 1px #4CAF50;
        }

        input:checked + .slider:before {
            -webkit-transform: translateX(22px);
            -ms-transform: translateX(22px);
            transform: translateX(22px);
        }

        /* History Page Specific Styles */
        .history-date-card {
            background-color: rgba(255, 255, 255, 0.15);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        .history-date-card h3 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #c4b5fd;
            margin-bottom: 10px;
        }
        .history-vision-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .history-vision-item:last-child {
            border-bottom: none;
        }
        .history-vision-item .vision-name {
            font-weight: 500;
            color: rgba(255, 255, 255, 0.9);
        }
        .history-toggle-btn {
            background-color: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            padding: 4px 8px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .history-toggle-btn.completed {
            background-color: #4CAF50;
            border-color: #4CAF50;
        }
        .history-toggle-btn:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }

        /* Reward System Specific Styles */
        .reward-section {
            background-color: rgba(255, 255, 255, 0.15);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            text-align: center;
        }
        .badge-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 10px;
            margin-top: 15px;
            justify-items: center;
        }
        .badge-item {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 8px;
            font-size: 0.75rem;
            font-weight: 600;
            text-align: center;
            opacity: 0.6; /* Dim unearned badges */
            transition: opacity 0.3s ease;
        }
        .badge-item.earned {
            opacity: 1;
            background-color: #FFD700; /* Gold for earned badges */
            color: #333;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        .badge-item img {
            width: 40px;
            height: 40px;
            margin: 0 auto 5px;
        }
        .xp-progress-bar-container {
            width: 100%;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
            height: 25px;
        }
        .xp-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #a78bfa, #c4b5fd);
            width: 0%;
            border-radius: 10px;
            transition: width 0.5s ease-in-out;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            font-weight: bold;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }
        .feature-unlock-card {
            background-color: rgba(255, 255, 255, 0.15);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            text-align: center;
        }
        .feature-unlock-card button {
            margin-top: 10px;
            opacity: 0.5;
            cursor: not-allowed;
        }
        .feature-unlock-card button.unlocked {
            opacity: 1;
            cursor: pointer;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen bg-home"> <!-- Changed initial background to home -->
    <div class="app-container">
        <!-- Opening Page - Hidden by default -->
        <div id="opening-page" class="page flex-col items-center justify-center p-8">
            <img src="https://ibb.co/1fq7VhfK" onerror="this.onerror=null;this.src='https://placehold.co/200x200/4A0E71/ffffff?text=Visionary+Logo';" alt="Visionary Logo" class="logo-img max-w-[200px] mb-6">
            <h1 class="stylish-heading-welcome mb-2">Welcome to <br>Visionary</h1>
            <p class="stylish-text-italic text-sm mb-10">BECOME THE VISIONARY OF YOUR OWN LIFE</p>
            <button id="vision-button" class="action-button text-xl px-12 py-4 rounded-full">Vision</button>
        </div>

        <!-- Intermediate Slide - Hidden by default -->
        <div id="intermediate-slide" class="intermediate-slide">
            <span class="text-line">Let's move towards your vision!</span>
        </div>

        <!-- Pages Wrapper for horizontal scrolling -->
        <div id="pages-wrapper"> <!-- Now visible by default -->
            <!-- Home Page -->
            <div id="home-page" class="page active"> <!-- Active by default on load -->
                <h2 class="stylish-heading-atomic mb-4 text-center">My Atomic Vision</h2>
                <p id="current-date-display" class="stylish-text text-md mb-4 text-center"></p>
                <p id="quote-display" class="stylish-text-italic text-lg mb-6 text-center"></p>
                <div id="visions-container" class="flex-grow">
                    <!-- Vision cards will be dynamically loaded here -->
                </div>
            </div>

            <!-- Analysis Page -->
            <div id="analysis-page" class="page">
                <h2 class="stylish-subheading text-3xl font-bold mb-6 text-center">Vision Analysis</h2>
                <div class="analysis-grid">
                    <div class="analysis-card">
                        <h3><span id="total-visions-count">0</span></h3>
                        <p class="stylish-text">Total Visions</p>
                    </div>
                    <div class="analysis-card">
                        <h3><span id="completed-today-count">0</span></h3>
                        <p class="stylish-text">Completed Today</p>
                    </div>
                    <div class="analysis-card">
                        <h3><span id="completion-rate-daily">0%</span></h3>
                        <p class="stylish-text">Daily Completion Rate</p>
                    </div>
                </div>

                <div class="reward-section mt-8">
                    <h3 class="stylish-subheading text-xl font-semibold mb-3">XP & Level</h3>
                    <p class="stylish-text text-md">Level: <span id="current-level">1</span></p>
                    <div class="xp-progress-bar-container">
                        <div id="xp-progress-bar" class="xp-progress-bar" style="width: 0%;">
                            <span id="xp-display">0/100 XP</span>
                        </div>
                    </div>
                </div>

                <div class="reward-section mt-4">
                    <h3 class="stylish-subheading text-xl font-semibold mb-3">Badges Earned</h3>
                    <div id="badges-display" class="badge-grid">
                        <!-- Badges will be dynamically loaded here -->
                    </div>
                </div>

                <div class="reward-section mt-4">
                    <h3 class="stylish-subheading text-xl font-semibold mb-3">Streaks</h3>
                    <p class="stylish-text text-md">Daily Streak: <span id="daily-streak">0</span> days</p>
                </div>

                <div class="reward-section mt-4">
                    <h3 class="stylish-subheading text-xl font-semibold mb-3">Unlockable Features</h3>
                    <div class="feature-unlock-card">
                        <p class="stylish-text">Mind-map Export</p>
                        <button id="mind-map-export-btn" class="action-button px-4 py-2 text-sm" disabled>Unlock (Level 5)</button>
                    </div>
                    <div class="feature-unlock-card mt-3">
                        <p class="stylish-text">Flashcard Generator</p>
                        <button id="flashcard-generator-btn" class="action-button px-4 py-2 text-sm" disabled>Unlock (Level 10)</button>
                    </div>
                    <div class="feature-unlock-card mt-3">
                        <p class="stylish-text">CSV Export</p>
                        <button id="csv-export-btn" class="action-button px-4 py-2 text-sm unlocked">Export Now</button>
                    </div>
                </div>

                <h3 class="stylish-subheading text-xl font-semibold mt-8 mb-4 text-center">Daily Progress</h3>
                <div id="daily-progress-container" class="space-y-4">
                    <!-- Daily progress bars will be dynamically loaded here -->
                </div>
                <p class="stylish-text text-sm mt-4 text-center">
                    Green: Completed Day, Red: Missed Day
                </p>

                <h3 class="stylish-subheading text-xl font-semibold mt-8 mb-4 text-center">Weekly Progress</h3>
                <div id="weekly-progress-container" class="space-y-4">
                    <!-- Weekly progress will be dynamically loaded here -->
                </div>

                <h3 class="stylish-subheading text-xl font-semibold mt-8 mb-4 text-center">Monthly Progress</h3>
                <div id="monthly-progress-container" class="space-y-4">
                    <!-- Monthly progress will be dynamically loaded here -->
                </div>

                <h3 class="stylish-subheading text-xl font-semibold mt-8 mb-4 text-center">Rewards</h3>
                <div id="rewards-container" class="p-4 bg-purple-700 bg-opacity-30 rounded-xl shadow-lg min-h-[80px] flex items-center justify-center">
                    <p id="rewards-text" class="stylish-text-italic text-md text-center">
                        Complete your visions to earn rewards.
                    </p>
                </div>
            </div>

            <!-- Mindset Insights Page -->
            <div id="mindset-insights-page" class="page">
                <h2 class="stylish-subheading text-3xl font-bold mb-6 text-center">Mindset Insights (Mindreader)</h2>
                <p class="stylish-text text-lg mb-4 text-center">Your mental state insights will be provided by analyzing the details of all your visions.</p>
                <button id="analyze-mindset-button" class="action-button w-full py-3 mb-4">Analyze Mindset</button>
                <div id="mindset-result" class="mt-6 p-4 bg-purple-700 bg-opacity-30 rounded-xl shadow-lg min-h-[100px] flex items-center justify-center">
                    <p id="mindset-text" class="stylish-text-italic text-md text-center">
                        Your mindset analysis will appear here.
                    </p>
                    <div id="mindset-loading" class="loading-spinner hidden"></div>
                </div>
            </div>

            <!-- AI Suggestions Page -->
            <div id="ai-suggestions-page" class="page">
                <h2 class="stylish-subheading text-3xl font-bold mb-6 text-center">AI Suggestions</h2>
                <div class="mt-4 p-4 bg-purple-700 bg-opacity-30 rounded-xl shadow-lg">
                    <h3 class="stylish-subheading text-xl font-semibold mb-3 text-center">Personalized AI Suggestions</h3>
                    <p id="ai-suggestion-text" class="stylish-text-italic text-md text-center">
                        Suggestions based on your visions and mindset analysis will appear here.
                    </p>
                    <button id="get-ai-suggestions-button" class="action-button w-full py-3 mt-4">Get New Suggestions</button>
                    <div id="ai-suggestions-loading" class="loading-spinner hidden"></div>
                </div>

                <div class="mt-8 p-4 bg-purple-700 bg-opacity-30 rounded-xl shadow-lg">
                    <h3 class="stylish-subheading text-xl font-semibold mb-3 text-center">General Text Analysis</h3>
                    <p class="stylish-text text-md mb-2 text-center">Write anything you want to analyze here.</p>
                    <textarea id="ai-general-analysis-input" class="ai-analysis-textarea w-full h-24 mb-4" placeholder="Write anything you want to analyze here."></textarea>
                    <button id="perform-ai-general-analysis-button" class="action-button w-full py-3">Analyze</button>
                    <div id="ai-general-analysis-result" class="mt-4 p-4 bg-purple-800 bg-opacity-40 rounded-xl shadow-inner min-h-[80px] flex items-center justify-center">
                        <p id="ai-general-analysis-text" class="stylish-text-italic text-md text-center">
                            Your general AI analysis will appear here.
                        </p>
                        <div id="ai-general-analysis-loading" class="loading-spinner hidden"></div>
                    </div>
                </div>
            </div>

            <!-- History Page -->
            <div id="history-page" class="page">
                <h2 class="stylish-subheading text-3xl font-bold mb-6 text-center">Vision History</h2>
                <div id="history-container" class="flex-grow">
                    <!-- History entries will be dynamically loaded here -->
                </div>
                <p class="stylish-text text-sm mt-4 text-center">
                    Use the toggle button to edit previous entries.
                </p>
            </div>

            <!-- Settings Page -->
            <div id="settings-page" class="page">
                <h2 class="stylish-subheading text-3xl font-bold mb-6 text-center">Settings</h2>
                
                <button id="add-vision-button-settings" class="action-button w-full py-3 mt-4 mb-6">Add New Vision</button>

                <div class="settings-option">
                    <p class="stylish-text">Dark Mode</p>
                    <label class="toggle-switch">
                        <input type="checkbox" id="dark-mode-toggle">
                        <span class="slider"></span>
                    </label>
                </div>

                <div class="settings-option">
                    <p class="stylish-text">Daily Reminders</p>
                    <label class="toggle-switch">
                        <input type="checkbox" id="reminders-toggle" checked>
                        <span class="slider"></span>
                    </label>
                </div>

                <div class="settings-option">
                    <p class="stylish-text">Export Data</p>
                    <button id="export-data-button" class="action-button px-4 py-2 text-sm">Export</button>
                </div>

                <div class="settings-option">
                    <p class="stylish-text">Reset All Data</p>
                    <button id="reset-app-button" class="delete-button px-4 py-2 text-sm">Reset</button>
                </div>
            </div>
        </div> <!-- End of pages-wrapper -->

        <!-- Navigation Bar -->
        <div class="nav-bar">
            <button id="nav-home" class="nav-button active" data-page="home-page">Home</button>
            <button id="nav-analysis" class="nav-button" data-page="analysis-page">Analysis</button>
            <button id="nav-mindset-insights" class="nav-button" data-page="mindset-insights-page">Mindset</button>
            <button id="nav-ai-suggestions" class="nav-button" data-page="ai-suggestions-page">AI</button>
            <button id="nav-history" class="nav-button" data-page="history-page">History</button>
            <button id="nav-settings" class="nav-button" data-page="settings-page">Settings</button>
        </div>

        <!-- Custom Modal for Alerts/Confirmations -->
        <div id="custom-modal" class="modal">
            <div class="modal-content">
                <p id="modal-message" class="stylish-text text-lg mb-6"></p>
                <div class="flex justify-center space-x-4">
                    <button id="modal-confirm" class="action-button px-6 py-2">OK</button>
                    <button id="modal-cancel" class="delete-button px-6 py-2 hidden">Cancel</button>
                </div>
            </div>
        </div>

        <!-- New Input Modal for text input -->
        <div id="input-modal" class="modal">
            <div class="modal-content">
                <p id="input-modal-message" class="stylish-text text-lg mb-6"></p>
                <input type="text" id="input-modal-field" class="stylish-text w-full p-2 rounded-lg bg-gray-700 text-white mb-4" placeholder="Enter text here...">
                <div class="flex justify-center space-x-4">
                    <button id="input-modal-confirm" class="action-button px-6 py-2">OK</button>
                    <button id="input-modal-cancel" class="delete-button px-6 py-2">Cancel</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // Quotes for the home page (Islamic, related to vision/self-improvement, and non-repeated)
        const quotes = [
            "\"Indeed, Allah does not change the condition of a people until they change what is in themselves.\" - Quran (13:11)",
            "\"Seek knowledge from the cradle to the grave.\" - Prophet Muhammad (PBUH)",
            "\"Do not lose hope, nor be sad.\" - Quran (3:139)",
            "\"Verily, with every hardship, there is ease.\" - Quran (94:5-6)",
            "\"The strong is not the one who overcomes people by his strength, but the strong is the one who controls himself when he is angry.\" - Prophet Muhammad (PBUH)",
            "\"Take account of yourselves before you are taken to account.\" - Umar ibn al-Khattab",
            "\"The world is a prison for the believer and a paradise for the disbeliever.\" - Prophet Muhammad (PBUH)"
        ];

        // Reward System Constants
        const XP_PER_VISION_COMPLETION = 10;
        const XP_BONUS_ALL_VISIONS_TODAY = 50;
        const XP_PER_LEVEL = 100; // XP needed to level up
        const BADGES = {
            GETTING_STARTED: { id: 'getting-started', name: 'Getting Started', description: 'Added your first 5 visions', icon: 'ðŸš€' },
            DAILY_CONQUEROR: { id: 'daily-conqueror', name: 'Daily Conqueror', description: 'Completed all visions for a day', icon: 'ðŸ†' },
            STUDY_STREAK_7: { id: 'study-streak-7', name: '7-Day Streak', description: 'Maintained a 7-day completion streak', icon: 'ðŸ”¥' },
            MIND_EXPLORER: { id: 'mind-explorer', name: 'Mind Explorer', description: 'Completed mindset analysis 3 times', icon: 'ðŸ§ ' }
        };
        const UNLOCKABLE_FEATURES = {
            MIND_MAP_EXPORT: { id: 'mind-map-export', name: 'Mind-map Export', unlockLevel: 5, buttonId: 'mind-map-export-btn' },
            FLASHCARD_GENERATOR: { id: 'flashcard-generator', name: 'Flashcard Generator', unlockLevel: 10, buttonId: 'flashcard-generator-btn' },
            CSV_EXPORT: { id: 'csv-export', name: 'CSV Export', unlocked: true, buttonId: 'csv-export-btn' } // Already available
        };

        // DOM Elements
        const openingPage = document.getElementById('opening-page');
        const visionButton = document.getElementById('vision-button');
        const intermediateSlide = document.getElementById('intermediate-slide');
        const quoteDisplay = document.getElementById('quote-display');
        const homePage = document.getElementById('home-page');
        const analysisPage = document.getElementById('analysis-page');
        const mindsetInsightsPage = document.getElementById('mindset-insights-page');
        const aiSuggestionsPage = document.getElementById('ai-suggestions-page');
        const historyPage = document.getElementById('history-page');
        const settingsPage = document.getElementById('settings-page');
        
        const pagesWrapper = document.getElementById('pages-wrapper');
        const contentPages = [homePage, analysisPage, mindsetInsightsPage, aiSuggestionsPage, historyPage, settingsPage]; 

        const navBar = document.querySelector('.nav-bar');
        const navButtons = document.querySelectorAll('.nav-button');
        const visionsContainer = document.getElementById('visions-container');
        const addVisionButtonSettings = document.getElementById('add-vision-button-settings');

        const totalVisionsCount = document.getElementById('total-visions-count');
        const completedTodayCount = document.getElementById('completed-today-count');
        const completionRateDaily = document.getElementById('completion-rate-daily');

        const dailyProgressContainer = document.getElementById('daily-progress-container');
        const weeklyProgressContainer = document.getElementById('weekly-progress-container');
        const monthlyProgressContainer = document.getElementById('monthly-progress-container');
        const rewardsContainer = document.getElementById('rewards-container');
        const rewardsText = document.getElementById('rewards-text');

        const currentLevelDisplay = document.getElementById('current-level');
        const xpProgressBar = document.getElementById('xp-progress-bar');
        const xpDisplay = document.getElementById('xp-display');
        const badgesDisplay = document.getElementById('badges-display');
        const dailyStreakDisplay = document.getElementById('daily-streak');

        const mindMapExportBtn = document.getElementById(UNLOCKABLE_FEATURES.MIND_MAP_EXPORT.buttonId);
        const flashcardGeneratorBtn = document.getElementById(UNLOCKABLE_FEATURES.FLASHCARD_GENERATOR.buttonId);
        const csvExportBtn = document.getElementById(UNLOCKABLE_FEATURES.CSV_EXPORT.buttonId);


        const analyzeMindsetButton = document.getElementById('analyze-mindset-button');
        const mindsetResult = document.getElementById('mindset-result');
        const mindsetText = document.getElementById('mindset-text');
        const mindsetLoading = document.getElementById('mindset-loading');

        const getAiSuggestionsButton = document.getElementById('get-ai-suggestions-button');
        const aiSuggestionText = document.getElementById('ai-suggestion-text');
        const aiSuggestionsLoading = document.getElementById('ai-suggestions-loading');

        const aiGeneralAnalysisInput = document.getElementById('ai-general-analysis-input');
        const performAiGeneralAnalysisButton = document.getElementById('perform-ai-general-analysis-button');
        const aiGeneralAnalysisResult = document.getElementById('ai-general-analysis-result');
        const aiGeneralAnalysisText = document.getElementById('ai-general-analysis-text');
        const aiGeneralAnalysisLoading = document.getElementById('ai-general-analysis-loading');

        const historyContainer = document.getElementById('history-container');

        const customModal = document.getElementById('custom-modal');
        const modalMessage = document.getElementById('modal-message');
        const modalConfirmButton = document.getElementById('modal-confirm');
        const modalCancelButton = document.getElementById('modal-cancel'); // Corrected assignment

        const inputModal = document.getElementById('input-modal');
        const inputModalMessage = document.getElementById('input-modal-message');
        const inputModalField = document.getElementById('input-modal-field');
        const inputModalConfirm = document.getElementById('input-modal-confirm');
        const inputModalCancel = document.getElementById('input-modal-cancel');

        const darkModeToggle = document.getElementById('dark-mode-toggle');
        const remindersToggle = document.getElementById('reminders-toggle');
        const exportDataButton = document.getElementById('export-data-button');
        const resetAppButton = document.getElementById('reset-app-button');

        let visions = [];
        let rewardsState = {
            xp: 0,
            level: 1,
            badges: [],
            currentDailyStreak: 0,
            lastDailyStreakDate: null,
            mindsetAnalysisCount: 0
        };
        const today = new Date().toDateString();

        // --- Utility Functions ---

        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), delay);
            };
        }

        function showCustomModal(message, isConfirm = false) {
            return new Promise((resolve) => {
                modalMessage.textContent = message;
                modalCancelButton.classList.toggle('hidden', !isConfirm);
                customModal.classList.add('show');

                const handleConfirm = () => {
                    customModal.classList.remove('show');
                    modalConfirmButton.removeEventListener('click', handleConfirm);
                    modalCancelButton.removeEventListener('click', handleCancel);
                    resolve(true);
                };

                const handleCancel = () => {
                    customModal.classList.remove('show');
                    modalConfirmButton.removeEventListener('click', handleConfirm);
                    modalCancelButton.removeEventListener('click', handleCancel);
                    resolve(false);
                };

                modalConfirmButton.addEventListener('click', handleConfirm);
                modalCancelButton.addEventListener('click', handleCancel);
            });
        }

        function showInputModal(message) {
            return new Promise((resolve) => {
                inputModalMessage.textContent = message;
                inputModalField.value = '';
                inputModal.classList.add('show');
                inputModalField.focus();

                const handleConfirm = () => {
                    inputModal.classList.remove('show');
                    inputModalConfirm.removeEventListener('click', handleConfirm);
                    inputModalCancel.removeEventListener('click', handleCancel);
                    resolve(inputModalField.value);
                };

                const handleCancel = () => {
                    inputModal.classList.remove('show');
                    inputModalConfirm.removeEventListener('click', handleConfirm);
                    inputModalCancel.removeEventListener('click', handleCancel);
                    resolve(null);
                };

                inputModalConfirm.addEventListener('click', handleConfirm);
                inputModalCancel.addEventListener('click', handleCancel);

                inputModalField.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        handleConfirm();
                    }
                }, { once: true });
            });
        }

        function generateUniqueId() {
            return '_' + Math.random().toString(36).substr(2, 9);
        }

        function saveVisions() {
            localStorage.setItem('visionaryVisions', JSON.stringify(visions));
        }

        function loadVisions() {
            const storedVisions = localStorage.getItem('visionaryVisions');
            if (storedVisions) {
                visions = JSON.parse(storedVisions);
            }
        }

        function saveRewardsState() {
            localStorage.setItem('visionaryRewardsState', JSON.stringify(rewardsState));
        }

        function loadRewardsState() {
            const storedState = localStorage.getItem('visionaryRewardsState');
            if (storedState) {
                rewardsState = JSON.parse(storedState);
                // Ensure default values if new properties are added later
                rewardsState.xp = rewardsState.xp || 0;
                rewardsState.level = rewardsState.level || 1;
                rewardsState.badges = rewardsState.badges || [];
                rewardsState.currentDailyStreak = rewardsState.currentDailyStreak || 0;
                rewardsState.lastDailyStreakDate = rewardsState.lastDailyStreakDate || null;
                rewardsState.mindsetAnalysisCount = rewardsState.mindsetAnalysisCount || 0;
            }
        }

        function awardXP(amount) {
            rewardsState.xp += amount;
            while (rewardsState.xp >= rewardsState.level * XP_PER_LEVEL) {
                rewardsState.xp -= rewardsState.level * XP_PER_LEVEL; // Carry over XP
                rewardsState.level++;
                showCustomModal(`Congratulations! You've reached Level ${rewardsState.level}!`);
            }
            saveRewardsState();
            updateAnalysisPage(); // Update UI
        }

        function earnBadge(badgeId) {
            if (!rewardsState.badges.includes(badgeId)) {
                rewardsState.badges.push(badgeId);
                saveRewardsState();
                const badge = Object.values(BADGES).find(b => b.id === badgeId);
                if (badge) {
                    showCustomModal(`New Badge Earned: ${badge.icon} ${badge.name}!`);
                }
                updateAnalysisPage(); // Update UI
            }
        }

        function checkDailyStreak() {
            const lastDate = rewardsState.lastDailyStreakDate;
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayString = yesterday.toDateString();

            const allVisionsCompletedToday = (visions.length > 0 && visions.every(v => v.completedDates.includes(today)));

            if (allVisionsCompletedToday) {
                if (!lastDate || lastDate === yesterdayString) {
                    rewardsState.currentDailyStreak++;
                } else if (lastDate !== today) { // If it's a new day and not yesterday, reset
                    rewardsState.currentDailyStreak = 1;
                }
                rewardsState.lastDailyStreakDate = today;
            } else {
                // If not all visions completed today, reset streak if it was active
                if (rewardsState.currentDailyStreak > 0 && rewardsState.lastDailyStreakDate !== today) {
                    rewardsState.currentDailyStreak = 0;
                }
            }
            saveRewardsState();
            // Check for streak badge
            if (rewardsState.currentDailyStreak >= 7) { // Example: 7-day streak
                earnBadge(BADGES.STUDY_STREAK_7.id);
            }
        }

        function renderVisions() {
            visionsContainer.innerHTML = '';
            if (visions.length === 0) {
                visionsContainer.innerHTML = `
                    <p class="stylish-text text-center mt-10">
                        You haven't added any visions yet.
                        <br>
                        Start by clicking 'Add New Vision' on the 'Settings' page.
                    </p>
                `;
            }
            visions.forEach(vision => {
                const isCompletedToday = vision.completedDates.includes(today);
                const visionCard = document.createElement('div');
                visionCard.className = 'vision-card';
                visionCard.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <input type="text" value="${vision.name}" class="stylish-text text-lg font-semibold w-full bg-transparent border-none focus:outline-none" data-id="${vision.id}" data-field="name">
                        <button class="delete-button ml-2" data-id="${vision.id}">Delete</button>
                    </div>
                    <textarea class="stylish-text w-full h-24 mt-2" placeholder="Write vision description here..." data-id="${vision.id}" data-field="description">${vision.description}</textarea>
                    <button class="vision-toggle-btn w-full ${isCompletedToday ? 'completed' : ''}" data-id="${vision.id}">
                        ${isCompletedToday ? 'Completed Today' : 'Mark Complete'}
                    </button>
                `;
                visionsContainer.appendChild(visionCard);
            });

            visionsContainer.querySelectorAll('input[type="text"]').forEach(input => {
                input.addEventListener('change', (e) => {
                    const id = e.target.dataset.id;
                    const field = e.target.dataset.field;
                    const value = e.target.value;
                    const visionIndex = visions.findIndex(v => v.id === id);
                    if (visionIndex > -1) {
                        visions[visionIndex][field] = value;
                        saveVisions();
                    }
                });
            });

            visionsContainer.querySelectorAll('textarea').forEach(textarea => {
                textarea.addEventListener('change', (e) => {
                    const id = e.target.dataset.id;
                    const field = e.target.dataset.field;
                    const value = e.target.value;
                    const visionIndex = visions.findIndex(v => v.id === id);
                    if (visionIndex > -1) {
                        visions[visionIndex][field] = value;
                        saveVisions();
                    }
                });
            });

            visionsContainer.querySelectorAll('.delete-button').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const idToDelete = e.target.dataset.id;
                    const confirmed = await showCustomModal('Are you sure you want to delete this vision?', true);
                    if (confirmed) {
                        visions = visions.filter(v => v.id !== idToDelete);
                        saveVisions();
                        renderVisions();
                        updateAnalysisPage();
                        renderHistoryPage();
                    }
                });
            });

            visionsContainer.querySelectorAll('.vision-toggle-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const idToToggle = e.target.dataset.id;
                    toggleVisionCompletion(idToToggle);
                });
            });
        }

        function toggleVisionCompletion(visionId, dateToToggle = today) {
            const vision = visions.find(v => v.id === visionId);
            if (vision) {
                const dateIndex = vision.completedDates.indexOf(dateToToggle);
                if (dateIndex === -1) {
                    vision.completedDates.push(dateToToggle);
                    if (dateToToggle === today) { // Only award XP for today's completion
                        awardXP(XP_PER_VISION_COMPLETION);
                    }
                } else {
                    vision.completedDates.splice(dateIndex, 1);
                    // Optionally deduct XP if unmarking, but for simplicity, we won't deduct.
                }
                saveVisions();
                
                // Check for "Daily Conqueror" and update streak after any vision completion change
                const allVisionsCompletedToday = (visions.length > 0 && visions.every(v => v.completedDates.includes(today)));
                if (allVisionsCompletedToday) {
                    earnBadge(BADGES.DAILY_CONQUEROR.id);
                    // Award bonus XP only once per day for completing all visions
                    const dailyConquerorRewardId = `daily-conqueror-xp-bonus-${today}`;
                    if (!rewardsState.badges.includes(dailyConquerorRewardId)) { // Use badge system to track one-time daily bonus
                        awardXP(XP_BONUS_ALL_VISIONS_TODAY);
                        rewardsState.badges.push(dailyConquerorRewardId); // Mark as awarded for today
                        saveRewardsState();
                    }
                } else {
                    // If daily conqueror is no longer met, remove the temporary badge marker
                    const dailyConquerorRewardId = `daily-conqueror-xp-bonus-${today}`;
                    const index = rewardsState.badges.indexOf(dailyConquerorRewardId);
                    if (index > -1) {
                        rewardsState.badges.splice(index, 1);
                        saveRewardsState();
                    }
                }
                checkDailyStreak(); // Always check streak after completion change

                if (document.getElementById('home-page').classList.contains('active')) {
                    renderVisions();
                }
                updateAnalysisPage();
                renderHistoryPage();
            }
        }

        /**
         * Switches between different pages of the app and manages background and scrolling.
         * @param {string} pageId - The ID of the page to show.
         */
        function showPage(pageId) {
            // Hide opening and intermediate pages if they are currently active
            openingPage.classList.remove('active');
            openingPage.classList.add('hidden');
            intermediateSlide.classList.remove('show');
            intermediateSlide.classList.add('hidden');

            // Ensure the pagesWrapper is visible
            pagesWrapper.classList.remove('hidden');
            navBar.classList.remove('hidden');

            // Find the target page element and its index
            let targetPageIndex = -1;
            for (let i = 0; i < contentPages.length; i++) {
                if (contentPages[i].id === pageId) {
                    targetPageIndex = i;
                    break;
                }
            }

            // Deactivate all content pages' 'active' class
            contentPages.forEach(page => {
                page.classList.remove('active');
            });

            if (targetPageIndex !== -1) {
                const targetPage = contentPages[targetPageIndex];
                targetPage.classList.add('active'); // Activate the target page

                // Scroll the pagesWrapper to the target page
                // Use requestAnimationFrame for smoother scrolling and to ensure layout is updated
                requestAnimationFrame(() => {
                    pagesWrapper.scrollLeft = targetPageIndex * pagesWrapper.offsetWidth;
                });
            }

            // Update active state of navigation buttons
            navButtons.forEach(button => {
                if (button.dataset.page === pageId) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            });

            // Update body background based on the current page
            document.body.className = '';
            if (pageId === 'home-page') {
                document.body.classList.add('bg-home');
            } else if (pageId === 'mindset-insights-page') {
                document.body.classList.add('bg-mindset');
            } else if (pageId === 'ai-suggestions-page') {
                document.body.classList.add('bg-ai');
            } else if (pageId === 'analysis-page') {
                document.body.classList.add('bg-analysis');
                updateAnalysisPage();
            } else if (pageId === 'settings-page') {
                document.body.classList.add('bg-settings');
            } else if (pageId === 'history-page') {
                document.body.classList.add('bg-history');
                renderHistoryPage();
            }
        }


        async function analyzeTextWithAI(textToAnalyze, resultElement, loadingElement, promptPrefix) {
            if (!textToAnalyze.trim()) {
                resultElement.textContent = 'Write something to analyze.';
                loadingElement.classList.add('hidden');
                return;
            }

            resultElement.textContent = '';
            loadingElement.classList.remove('hidden');

            try {
                let chatHistory = [];
                const prompt = `${promptPrefix}\n\nUser input: "${textToAnalyze}"`;
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });

                const payload = { contents: chatHistory };
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    resultElement.textContent = text;
                } else {
                    resultElement.textContent = 'Analysis unavailable: Failed to get response from AI.';
                    console.error('Unexpected API response structure:', result);
                }
            } catch (error) {
                resultElement.textContent = 'Analysis error: ' + error.message;
                console.error('Error during AI analysis:', error);
            } finally {
                loadingElement.classList.add('hidden');
            }
        }

        function getStartOfWeek(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day;
            d.setDate(diff);
            d.setHours(0, 0, 0, 0);
            return d;
        }

        function getStartOfMonth(date) {
            const d = new Date(date);
            d.setDate(1);
            d.setHours(0, 0, 0, 0);
            return d;
        }

        function updateAnalysisPage() {
            const totalVisions = visions.length;

            const completedToday = visions.filter(v => v.completedDates.includes(today)).length;
            const dailyCompletionRate = totalVisions > 0 ? Math.round((completedToday / totalVisions) * 100) : 0;

            totalVisionsCount.textContent = totalVisions;
            completedTodayCount.textContent = completedToday;
            completionRateDaily.textContent = `${dailyCompletionRate}%`;

            // Update XP and Level Display
            currentLevelDisplay.textContent = rewardsState.level;
            const xpProgress = (rewardsState.xp / (rewardsState.level * XP_PER_LEVEL)) * 100;
            xpProgressBar.style.width = `${xpProgress}%`;
            xpDisplay.textContent = `${rewardsState.xp}/${rewardsState.level * XP_PER_LEVEL} XP`;

            // Update Badges Display
            badgesDisplay.innerHTML = '';
            Object.values(BADGES).forEach(badge => {
                const isEarned = rewardsState.badges.includes(badge.id);
                const badgeItem = document.createElement('div');
                badgeItem.className = `badge-item ${isEarned ? 'earned' : ''}`;
                badgeItem.innerHTML = `
                    <span class="text-2xl">${badge.icon}</span>
                    <p>${badge.name}</p>
                `;
                badgesDisplay.appendChild(badgeItem);
            });

            // Update Daily Streak Display
            dailyStreakDisplay.textContent = rewardsState.currentDailyStreak;

            // Update Unlockable Features
            Object.values(UNLOCKABLE_FEATURES).forEach(feature => {
                const button = document.getElementById(feature.buttonId);
                if (button) {
                    if (feature.unlocked || rewardsState.level >= feature.unlockLevel) {
                        button.classList.add('unlocked');
                        button.disabled = false;
                        button.textContent = feature.name === 'CSV Export' ? 'Export Now' : 'Unlocked!';
                    } else {
                        button.classList.remove('unlocked');
                        button.disabled = true;
                        button.textContent = `Unlock (Level ${feature.unlockLevel})`;
                    }
                }
            });


            dailyProgressContainer.innerHTML = '';
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateString = date.toDateString();
                const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });

                const visionsCompletedOnDay = visions.filter(v => v.completedDates.includes(dateString)).length;
                const dailyPercentage = totalVisions > 0 ? Math.round((visionsCompletedOnDay / totalVisions) * 100) : 0;

                const progressBarClass = visionsCompletedOnDay === totalVisions && totalVisions > 0 ? 'completed' : (visionsCompletedOnDay > 0 ? '' : 'red');

                const progressHtml = `
                    <div class="flex items-center space-x-2">
                        <span class="w-12 text-right text-sm stylish-text">${dayName}</span>
                        <div class="progress-bar-container flex-grow">
                            <div class="progress-bar ${progressBarClass}" style="width: ${dailyPercentage}%;">
                                ${dailyPercentage}%
                            </div>
                        </div>
                    </div>
                `;
                dailyProgressContainer.insertAdjacentHTML('beforeend', progressHtml);
            }

            weeklyProgressContainer.innerHTML = '';
            for (let i = 3; i >= 0; i--) {
                const endDate = new Date();
                endDate.setDate(endDate.getDate() - (i * 7));
                const startDate = getStartOfWeek(endDate);
                
                let totalCompletedInWeek = 0;
                let totalPossibleInWeek = 0;

                for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                    const dayString = d.toDateString();
                    totalPossibleInWeek += totalVisions;
                    visions.forEach(vision => {
                        if (vision.completedDates.includes(dayString)) {
                            totalCompletedInWeek++;
                        }
                    });
                }
                
                const weeklyCompletionRate = totalPossibleInWeek > 0 ? Math.round((totalCompletedInWeek / totalPossibleInWeek) * 100) : 0;
                const weekLabel = `Week of ${startDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`;

                const weeklyHtml = `
                    <div class="analysis-card">
                        <h3 class="stylish-text">${weekLabel}</h3>
                        <p class="stylish-text">Completed: ${totalCompletedInWeek} / ${totalPossibleInWeek}</p>
                        <p class="stylish-text">Rate: ${weeklyCompletionRate}%</p>
                    </div>
                `;
                weeklyProgressContainer.insertAdjacentHTML('beforeend', weeklyHtml);
            }

            monthlyProgressContainer.innerHTML = '';
            for (let i = 2; i >= 0; i--) {
                const date = new Date();
                date.setMonth(date.getMonth() - i);
                const startDate = getStartOfMonth(date);
                const endDate = new Date(startDate);
                endDate.setMonth(endDate.getMonth() + 1);
                endDate.setDate(0);

                let totalCompletedInMonth = 0;
                let totalPossibleInMonth = 0;

                for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                    const dayString = d.toDateString();
                    totalPossibleInMonth += totalVisions;
                    visions.forEach(vision => {
                        if (vision.completedDates.includes(dayString)) {
                            totalCompletedInMonth++;
                        }
                    });
                }

                const monthlyCompletionRate = totalPossibleInMonth > 0 ? Math.round((totalCompletedInMonth / totalPossibleInMonth) * 100) : 0;
                const monthLabel = startDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

                const monthlyHtml = `
                    <div class="analysis-card">
                        <h3 class="stylish-text">${monthLabel}</h3>
                        <p class="stylish-text">Completed: ${totalCompletedInMonth} / ${totalPossibleInMonth}</p>
                        <p class="stylish-text">Rate: ${monthlyCompletionRate}%</p>
                    </div>
                `;
                monthlyProgressContainer.insertAdjacentHTML('beforeend', monthlyHtml);
            }

            // Basic reward logic: Earn a reward for completing all visions today
            // This is now handled by the general badge system and XP system
            if (rewardsState.badges.includes(BADGES.DAILY_CONQUEROR.id)) {
                rewardsText.textContent = 'You are consistently completing your visions!';
            } else {
                rewardsText.textContent = 'Complete all your visions today to earn the Daily Conqueror badge!';
            }
        }

        async function performMindsetAnalysis() {
            const allVisionDescriptions = visions.map(v => v.description).filter(Boolean).join('\n\n');
            if (!allVisionDescriptions) {
                mindsetText.textContent = 'Write some details in your visions to perform analysis.';
                return;
            }

            // Increment analysis count and check for badge
            rewardsState.mindsetAnalysisCount++;
            saveRewardsState();
            if (rewardsState.mindsetAnalysisCount >= 3) { // Example: 3 analyses for badge
                earnBadge(BADGES.MIND_EXPLORER.id);
            }

            // Trigger confetti for first analysis
            if (rewardsState.mindsetAnalysisCount === 1 && !rewardsState.badges.includes('first-mindset-analysis-confetti')) {
                showCustomModal('ðŸŽ‰ First Mindset Analysis Complete! ðŸŽ‰');
                rewardsState.badges.push('first-mindset-analysis-confetti'); // Mark confetti shown
                saveRewardsState();
            }

            const prompt = `Analyze the user's overall mindset, psychological state, and potential areas for growth based on the following collection of their vision descriptions. Provide a holistic, empathetic, and encouraging insight. Avoid diagnostic language. Focus on recurring themes, emotional tones, and offer general advice for well-being and personal development. Respond in English.`;
            await analyzeTextWithAI(allVisionDescriptions, mindsetText, mindsetLoading, prompt);
        }

        async function getPersonalizedAISuggestions() {
            const allVisionDescriptions = visions.map(v => v.description).filter(Boolean).join('\n\n');
            const completedToday = visions.filter(v => v.completedDates.includes(today)).length;
            const totalVisions = visions.length;
            const dailyCompletionRate = totalVisions > 0 ? Math.round((completedToday / totalVisions) * 100) : 0;

            let context = `User's visions descriptions:\n"${allVisionDescriptions || 'No descriptions provided.'}"\n`;
            context += `Today's completion rate: ${dailyCompletionRate}% (${completedToday} out of ${totalVisions} visions completed).\n`;

            const prompt = `Based on the following context about the user's visions and their daily progress, provide personalized AI suggestions for new habits or ways to improve their current vision tracking and overall well-being. Focus on actionable, encouraging advice. Respond in English.`;
            await analyzeTextWithAI(context, aiSuggestionText, aiSuggestionsLoading, prompt);
        }

        function renderHistoryPage() {
            historyContainer.innerHTML = '';
            const allDates = new Set();
            visions.forEach(vision => {
                vision.completedDates.forEach(date => allDates.add(date));
            });

            const sortedDates = Array.from(allDates).sort((a, b) => new Date(b) - new Date(a));

            if (sortedDates.length === 0) {
                historyContainer.innerHTML = `
                    <p class="stylish-text text-center mt-10">
                        No vision history available yet.
                        <br>
                        Start completing your visions!
                    </p>
                `;
                return;
            }

            sortedDates.forEach(dateString => {
                const historyDateCard = document.createElement('div');
                historyDateCard.className = 'history-date-card';
                historyDateCard.innerHTML = `
                    <h3 class="stylish-text">${new Date(dateString).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</h3>
                    <div class="space-y-2 mt-4">
                        <!-- Visions for this date will be loaded here -->
                    </div>
                `;
                const visionsForDateContainer = historyDateCard.querySelector('div');

                visions.forEach(vision => {
                    const isCompletedOnDate = vision.completedDates.includes(dateString);
                    const visionItem = document.createElement('div');
                    visionItem.className = 'history-vision-item';
                    visionItem.innerHTML = `
                        <span class="vision-name stylish-text">${vision.name}</span>
                        <button class="history-toggle-btn ${isCompletedOnDate ? 'completed' : ''}" 
                                data-vision-id="${vision.id}" data-date="${dateString}">
                            ${isCompletedOnDate ? 'Completed' : 'Missed'}
                        </button>
                    `;
                    visionsForDateContainer.appendChild(visionItem);
                });
                historyContainer.appendChild(historyDateCard);
            });

            historyContainer.querySelectorAll('.history-toggle-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const visionId = e.target.dataset.visionId;
                    const date = e.target.dataset.date;
                    toggleVisionCompletion(visionId, date);
                });
            });
        }

        async function exportData() {
            const confirmed = await showCustomModal('Are you sure you want to export your data?', true);
            if (confirmed) {
                const dataStr = JSON.stringify(visions, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                
                const exportFileDefaultName = 'visionary-visions.json';
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
                showCustomModal('Data successfully exported.');
            }
        }

        async function resetApp() {
            const confirmed = await showCustomModal('Are you sure you want to reset all data? This action cannot be undone.', true);
            if (confirmed) {
                localStorage.clear();
                visions = [];
                rewardsState = {
                    xp: 0,
                    level: 1,
                    badges: [],
                    currentDailyStreak: 0,
                    lastDailyStreakDate: null,
                    mindsetAnalysisCount: 0
                };
                saveRewardsState(); // Save reset state
                renderVisions();
                updateAnalysisPage();
                renderHistoryPage();
                darkModeToggle.checked = false;
                remindersToggle.checked = true;
                showCustomModal('All data successfully reset.');
                showPage('home-page'); 
            }
        }

        // --- Event Listeners ---

        navButtons.forEach(button => {
            button.addEventListener('click', () => {
                showPage(button.dataset.page);
            });
        });

        addVisionButtonSettings.addEventListener('click', async () => {
            const newVisionNamePrompt = "Enter new vision name:";
            const newVisionName = await showInputModal(newVisionNamePrompt);
            if (newVisionName && newVisionName.trim()) {
                const newVision = {
                    id: generateUniqueId(),
                    name: newVisionName.trim(),
                    description: "",
                    completedDates: []
                };
                visions.push(newVision);
                saveVisions();
                // Check for "Getting Started" badge
                if (visions.length >= 5) { // Example: 5 visions for badge
                    earnBadge(BADGES.GETTING_STARTED.id);
                }
                renderVisions();
                showCustomModal('Vision successfully added.');
                updateAnalysisPage();
                renderHistoryPage();
            } else if (newVisionName !== null) {
                showCustomModal('Vision name cannot be empty.');
            }
        });

        analyzeMindsetButton.addEventListener('click', performMindsetAnalysis);
        getAiSuggestionsButton.addEventListener('click', getPersonalizedAISuggestions);
        performAiGeneralAnalysisButton.addEventListener('click', () => {
            const text = aiGeneralAnalysisInput.value;
            const prompt = "Analyze the following text and provide a concise summary or key insights. If the text appears to be a personal reflection or related to mindset, offer general, encouraging feedback or relevant observations. Respond in English.";
            analyzeTextWithAI(text, aiGeneralAnalysisText, aiGeneralAnalysisLoading, prompt);
        });

        darkModeToggle.addEventListener('change', () => {
            showCustomModal(`Dark Mode ${darkModeToggle.checked ? 'Enabled' : 'Disabled'}. (Functionality not fully implemented for this theme)`);
        });

        remindersToggle.addEventListener('change', () => {
            showCustomModal(`Daily Reminders ${remindersToggle.checked ? 'Enabled' : 'Disabled'}. (Functionality not implemented)`);
        });

        exportDataButton.addEventListener('click', exportData);
        resetAppButton.addEventListener('click', resetApp);

        // Unlockable Feature Buttons (placeholders)
        mindMapExportBtn.addEventListener('click', () => {
            showCustomModal("Mind-map Export feature is unlocked but not yet functional.");
        });
        flashcardGeneratorBtn.addEventListener('click', () => {
            showCustomModal("Flashcard Generator feature is unlocked but not yet functional.");
        });
        csvExportBtn.addEventListener('click', exportData); // CSV export uses existing exportData function


        // --- Initialization ---

        document.addEventListener('DOMContentLoaded', () => {
            // Display a random quote on home page
            const randomIndex = Math.floor(Math.random() * quotes.length);
            quoteDisplay.textContent = quotes[randomIndex];

            document.getElementById('current-date-display').textContent = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

            loadVisions();
            loadRewardsState(); // Load rewards state

            // Check streak status for today on load
            checkDailyStreak(); 

            renderVisions(); // Render visions on initial load
            updateAnalysisPage(); // Update analysis page with rewards info

            // Directly show the home page and main content wrapper
            showPage('home-page'); // This will set the correct background and activate home page
        });

    </script>
</body>
</html>